loader: taskgraph.loader.transform:loader

transforms:
  - taskgraph.transforms.task_context
  - src.transforms.github:transforms
  - src.transforms.github_cached:transforms
  - taskgraph.transforms.run:transforms
  - taskgraph.transforms.task:transforms
  - eije_taskgraph.transforms.common:transforms

task-defaults:
  worker:
    docker-image: ghcr.io/eijebong/apwm:latest
    max-run-time: 1800
    volumes:
      - /builds/worker/checkouts
    taskcluster-proxy: true
  run-on-tasks-for: ["github-pull-request", "github-pull-request-untrusted"]
  optimization:
    skip-unless-changed: ["index.toml", "index/**"]

tasks:
  index:
    worker-type: linux-small
    description: Run apwm diff
    scopes:
      - github:create-comment:Eijebong/Archipelago-index
    task-context:
      from-parameters:
        base_rev: base_rev
      substitution-fields:
        - run.command
    run:
      using: run-task
      command: >-
        cd $VCS_PATH &&
        mkdir -p /builds/worker/diffs &&
        apwm diff -i ./ -f https://github.com/Eijebong/Archipelago-index -r {base_rev} -o /builds/worker/diffs &&
        (
          [ -z "$( ls -A '/builds/worker/diffs' )" ] &&
          /usr/bin/curl --header "Content-Type: application/json" ${{TASKCLUSTER_PROXY_URL}}/github/v1/repository/Eijebong/Archipelago-index/issues/${{GITHUB_PR}}/comments --data "{{\"body\": \"No reviewable changes\"}}" ||
          /usr/bin/curl --header "Content-Type: application/json" ${{TASKCLUSTER_PROXY_URL}}/github/v1/repository/Eijebong/Archipelago-index/issues/${{GITHUB_PR}}/comments --data "{{\"body\": \"[Review changes](https://apdiff.bananium.fr/${{TASK_ID}})\"}}"
        )
    worker:
      artifacts:
        - type: directory
          path: /builds/worker/diffs
          name: public/diffs
        - type: file
          path: /builds/worker/checkouts/vcs/index.lock
          name: public/build/index.lock
